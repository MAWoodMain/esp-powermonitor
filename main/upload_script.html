<html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
        <script defer="" src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
        <title> ESP Power Monitor</title>
    </head>
    <body>
        <section class="section">
            <div class="tile is-ancestor">
                <div class="tile is-vertical is-12">
                    <div class="tile">
                        <div class="tile is-parent is-vertical">
                            <article class="tile is-child notification is-light">
                                <p class="title">WI-FI</p>
                                <div class="field">
                                    <label class="label">SSID</label>
                                    <div class="control">
                                        <input id="ssidInput" class="input" type="text" placeholder="Silence of the LANs">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Password</label>
                                    <p class="control has-icons-left">
                                        <input id="passwordInput" class="input" type="password" placeholder="Password">
                                        <!--<input id=abc" class="input" type="password" placeholder="Password"> -->
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="control">
                                    <button id="saveWifiButton" class="button is-dark">Save</button>
                                </div>
                                <br>
                                <p class="title">MQTT</p>
                                <div class="field">
                                    <label class="label">URI</label>
                                    <div class="control">
                                        <input id="mqttAddress" class="input" type="text" placeholder="mqtt://10.0.1.1:1883">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Username</label>
                                    <input id="mqttUsernameInput" class="input" type="text" placeholder="jeff">
                                </div>
                                <div class="field">
                                    <label class="label">Password</label>
                                    <p class="control has-icons-left">

                                        <input id="mqttPasswordInput" class="input" type="password" placeholder="Password">
                                        <!--<input id=abc" class="input" type="password" placeholder="Password"> -->
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="control">
                                    <button id="saveMqttButton" class="button is-dark">Save</button>
                                </div>
                            </article>
<!--                            <article class="tile is-child notification is-warning">
                                <p class="title">...tiles</p>
                                <p class="subtitle">Bottom tile</p>
                            </article>-->
                        </div>
                        <div class="tile is-parent">
                            <article class="tile is-child notification is-info">
                                <p class="title">Info</p>
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                    <tr>
                                        <td>MACAddress</td>
                                        <th id="macText"><i class="fas fa-question"></i></th>
                                    </tr>
                                    <tr>
                                        <td>Uptime</td>
                                        <td id="uptimeText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Battery status</td>
                                        <td id="statusText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Vpp voltage</td>
                                        <td id="voltageText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </article>
                        </div>
                        <div class="tile is-parent">
                            <article class="tile is-child notification is-info">
                                <p class="title">Measurement</p>
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                    <tr>
                                        <td>Condition</td>
                                        <th id="measurementConditionText"><i class="fas fa-question"></i></th>
                                    </tr>
                                    <tr>
                                        <td>Voltage</td>
                                        <td id="measurementVoltageText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Frequency</td>
                                        <td id="measurementFrequencyText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </article>
                        </div>
                    </div>
                </div>
            </div><!--
                    <div class="tile is-parent">
                        <article class="tile is-child notification is-danger">
                            <p class="title">Wide tile</p>
                            <p class="subtitle">Aligned with the right tile</p>
                            <div class="content">
                                &lt;!&ndash; Content &ndash;&gt;
                            </div>
                        </article>
                    </div>
                </div>
                <div class="tile is-parent">
                    <article class="tile is-child notification is-success">
                        <div class="content">
                            <p class="title">Tall tile</p>
                            <p class="subtitle">With even more content</p>
                            <div class="content">
                                &lt;!&ndash; Content &ndash;&gt;
                            </div>
                        </div>
                    </article>
                </div>-->
        </section>
    </body>
    <footer>
        <script>
            var getJSON = function(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.responseType = 'json';
                xhr.onload = function() {
                    var status = xhr.status;
                    if (status === 200) {
                        callback(null, xhr.response);
                    } else {
                        callback(status, xhr.response);
                    }
                };
                xhr.send();
            };


            function updateData()
            {
                getJSON('/battery',
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            if(data.voltage > 0.1)
                            {
                                document.getElementById("voltageText").innerText = data.voltage;
                            }
                            document.getElementById("statusText").innerText = data.status;
                            document.getElementById("uptimeText").innerText = data.uptime;
                        }
                    });
                getJSON('/pm',
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            document.getElementById("measurementConditionText").innerText = data.condition;
                            if(data.condition === "OK")
                            {
                                document.getElementById("measurementVoltageText").innerText = data.vrms + " Vrms";
                                document.getElementById("measurementFrequencyText").innerText = data.frequency + " Hz";
                            }
                            else
                            {
                                document.getElementById("measurementVoltageText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementFrequencyText").innerHTML = "<i class=\"fas fa-question\"></i>";
                            }
                        }
                    });
            }
            getJSON('/mac',
                function(err, data) {
                    if (err !== null) {
                        alert('Something went wrong: ' + err);
                    } else {
                        document.getElementById("macText").innerText = data.MACAddress;
                    }
                });
            updateData();
            setInterval(updateData, 1000);

            document.getElementById("saveWifiButton").addEventListener("click", ()=>
            {
                if(document.getElementById("ssidInput").value.length === 0)
                {
                    alert("Please enter an SSID");
                    return;
                }
                if(document.getElementById("passwordInput").value.length < 8)
                {
                    alert("Entered password is too short, must be at least 8 characters long");
                    return;
                }
                getJSON('/wifi?ssid=' + encodeURIComponent(document.getElementById("ssidInput").value) + '&password=' + encodeURIComponent(document.getElementById("passwordInput").value),
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            alert(data.msg)
                        }
                    });
            });

            document.getElementById("saveMqttButton").addEventListener("click", ()=>
            {
                if(document.getElementById("mqttAddress").value.length < 8)
                {
                    alert("Please enter a valid URI");
                    return;
                }
                getJSON('/mqtt?uri=' + encodeURIComponent(document.getElementById("mqttAddress").value) + '&username=' + encodeURIComponent(document.getElementById("mqttUsernameInput").value) + '&password=' + encodeURIComponent(document.getElementById("mqttPasswordInput").value),
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            alert(data.msg)
                        }
                    });
            });
        </script>
    </footer>
</html>
