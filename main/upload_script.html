<html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
        <script defer="" src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
        <title> ESP Power Monitor</title>
    </head>
    <body>
        <section class="section">
            <div class="tile is-ancestor">
                <div class="tile is-vertical is-12">
                    <div class="tile">
                        <div class="tile is-parent is-vertical">
                            <article class="tile is-child notification is-light">
                                <p class="title">WI-FI</p>
                                <div class="field">
                                    <label class="label">SSID</label>
                                    <div class="control">
                                        <input id="ssidInput" class="input" type="text" placeholder="Silence of the LANs">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Password</label>
                                    <p class="control has-icons-left">
                                        <input id="passwordInput" class="input" type="password" placeholder="Password">
                                        <!--<input id=abc" class="input" type="password" placeholder="Password"> -->
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="control">
                                    <button id="saveWifiButton" class="button is-dark">Save</button>
                                </div>
                                <br>
                                <p class="title">MQTT</p>
                                <div class="field">
                                    <label class="label">URI</label>
                                    <div class="control">
                                        <input id="mqttAddress" class="input" type="text" placeholder="mqtt://10.0.1.1:1883">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Username</label>
                                    <input id="mqttUsernameInput" class="input" type="text" placeholder="jeff">
                                </div>
                                <div class="field">
                                    <label class="label">Password</label>
                                    <p class="control has-icons-left">

                                        <input id="mqttPasswordInput" class="input" type="password" placeholder="Password">
                                        <!--<input id=abc" class="input" type="password" placeholder="Password"> -->
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="control">
                                    <button id="saveMqttButton" class="button is-dark">Save</button>
                                </div>
                            </article>
<!--                            <article class="tile is-child notification is-warning">
                                <p class="title">...tiles</p>
                                <p class="subtitle">Bottom tile</p>
                            </article>-->
                        </div>
                        <div class="tile is-parent">
                            <article class="tile is-child notification is-info">
                                <p class="title">Info</p>
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                    <tr>
                                        <td>MACAddress</td>
                                        <th id="macText"><i class="fas fa-question"></i></th>
                                    </tr>
                                    <tr>
                                        <td>Uptime</td>
                                        <td id="uptimeText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Battery status</td>
                                        <td id="statusText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Vpp voltage</td>
                                        <td id="voltageText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    </tbody>
                                </table>
                                <p class="title">Measurement <button id="resetCalButton" class="button is-dark is-small is-rounded">Reset Cal</button></p>
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                    <tr>
                                        <td>Condition</td>
                                        <th colspan="2" id="measurementConditionText"><i class="fas fa-question"></i></th>
                                    </tr>
                                    <tr>
                                        <td>Voltage</td>
                                        <td id="measurementVoltageText"><i class="fas fa-question"></i></td>
                                        <td><button id="calVoltageButton" class="button is-dark is-small is-rounded">Cal V</button></td>
                                    </tr>
                                    <tr>
                                        <td>Frequency</td>
                                        <td colspan="2" id="measurementFrequencyText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <th style="text-align:center" colspan="2">Channel 1</th>
                                        <td><button id="calI1Button" class="button is-dark is-small is-rounded">Cal I</button></td>
                                    </tr>
                                    <tr>
                                        <td>Current</td>
                                        <td colspan="2" id="measurementCurrentOneText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Real Power</td>
                                        <td colspan="2" id="measurementRPOneText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Apparent Power</td>
                                        <td colspan="2" id="measurementAPOneText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <th style="text-align:center" colspan="2">Channel 2</th>
                                        <td><button id="calI2Button" class="button is-dark is-small is-rounded">Cal I</button></td>
                                    </tr>
                                    <tr>
                                        <td>Current</td>
                                        <td colspan="2" id="measurementCurrentTwoText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Real Power</td>
                                        <td colspan="2" id="measurementRPTwoText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Apparent Power</td>
                                        <td colspan="2" id="measurementAPTwoText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <th style="vertical-align: middle; text-align:center" colspan="2">Channel 3</th>
                                        <td><button id="calI3Button" class="button is-dark is-small is-rounded">Cal I</button></td>
                                    </tr>
                                    <tr>
                                        <td>Current</td>
                                        <td colspan="2" id="measurementCurrentThreeText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Real Power</td>
                                        <td colspan="2" id="measurementRPThreeText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Apparent Power</td>
                                        <td colspan="2" id="measurementAPThreeText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <th style="vertical-align: middle; text-align:center" colspan="2">Channel 4</th>
                                        <td><button id="calI4Button" class="button is-dark is-small is-rounded">Cal I</button></td>
                                    </tr>
                                    <tr>
                                        <td>Current</td>
                                        <td colspan="2" id="measurementCurrentFourText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Real Power</td>
                                        <td colspan="2" id="measurementRPFourText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Apparent Power</td>
                                        <td colspan="2" id="measurementAPFourText"><i class="fas fa-question"></i></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </article>
                        </div>
                    </div>
                </div>
            </div>
            <!--
                    <div class="tile is-parent">
                        <article class="tile is-child notification is-danger">
                            <p class="title">Wide tile</p>
                            <p class="subtitle">Aligned with the right tile</p>
                            <div class="content">
                                &lt;!&ndash; Content &ndash;&gt;
                            </div>
                        </article>
                    </div>
                </div>
                <div class="tile is-parent">
                    <article class="tile is-child notification is-success">
                        <div class="content">
                            <p class="title">Tall tile</p>
                            <p class="subtitle">With even more content</p>
                            <div class="content">
                                &lt;!&ndash; Content &ndash;&gt;
                            </div>
                        </div>
                    </article>
                </div>-->
        </section>
    </body>
    <footer>
        <script>
            var getJSON = function(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.responseType = 'json';
                xhr.timeout = 1000;
                xhr.onload = function() {
                    var status = xhr.status;
                    if (status === 200) {
                        callback(null, xhr.response);
                    } else {
                        callback(status, xhr.response);
                    }
                };
                xhr.send();
            };


            function updateData()
            {
                getJSON('/battery',
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            if(data.voltage > 0.1)
                            {
                                document.getElementById("voltageText").innerText = data.voltage;
                            }
                            document.getElementById("statusText").innerText = data.status;
                            document.getElementById("uptimeText").innerText = data.uptime;
                        }
                    });
                getJSON('/pm',
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            document.getElementById("measurementConditionText").innerText = data.condition;
                            if(data.condition === "OK")
                            {
                                document.getElementById("measurementVoltageText").innerText = data.vrms + " Vrms";
                                document.getElementById("measurementFrequencyText").innerText = data.frequency + " Hz";

                                document.getElementById("measurementCurrentOneText").innerText = data.irms[0] + " A";
                                document.getElementById("measurementCurrentTwoText").innerText = data.irms[1] + " A";
                                document.getElementById("measurementCurrentThreeText").innerText = data.irms[2] + " A";
                                document.getElementById("measurementCurrentFourText").innerText = data.irms[3] + " A";

                                document.getElementById("measurementRPOneText").innerText = data.prms[0] + " W";
                                document.getElementById("measurementRPTwoText").innerText = data.prms[1] + " W";
                                document.getElementById("measurementRPThreeText").innerText = data.prms[2] + " W";
                                document.getElementById("measurementRPFourText").innerText = data.prms[3] + " W";

                                document.getElementById("measurementAPOneText").innerText = data.varms[0] + " VA";
                                document.getElementById("measurementAPTwoText").innerText = data.varms[1] + " VA";
                                document.getElementById("measurementAPThreeText").innerText = data.varms[2] + " VA";
                                document.getElementById("measurementAPFourText").innerText = data.varms[3] + " VA";
                            }
                            else
                            {
                                document.getElementById("measurementVoltageText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementFrequencyText").innerHTML = "<i class=\"fas fa-question\"></i>";

                                document.getElementById("measurementCurrentOneText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementCurrentTwoText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementCurrentThreeText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementCurrentFourText").innerHTML = "<i class=\"fas fa-question\"></i>";

                                document.getElementById("measurementRPOneText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementRPTwoText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementRPThreeText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementRPFourText").innerHTML = "<i class=\"fas fa-question\"></i>";

                                document.getElementById("measurementAPOneText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementAPTwoText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementAPThreeText").innerHTML = "<i class=\"fas fa-question\"></i>";
                                document.getElementById("measurementAPFourText").innerHTML = "<i class=\"fas fa-question\"></i>";
                            }
                        }
                    });
            }
            getJSON('/mac',
                function(err, data) {
                    if (err !== null) {
                        alert('Something went wrong: ' + err);
                    } else {
                        document.getElementById("macText").innerText = data.MACAddress;
                    }
                });
            updateData();
            setInterval(updateData, 1000);

            document.getElementById("saveWifiButton").addEventListener("click", ()=>
            {
                if(document.getElementById("ssidInput").value.length === 0)
                {
                    alert("Please enter an SSID");
                    return;
                }
                if(document.getElementById("passwordInput").value.length < 8)
                {
                    alert("Entered password is too short, must be at least 8 characters long");
                    return;
                }
                getJSON('/wifi?ssid=' + encodeURIComponent(document.getElementById("ssidInput").value) + '&password=' + encodeURIComponent(document.getElementById("passwordInput").value),
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            alert(data.msg)
                        }
                    });
            });

            document.getElementById("saveMqttButton").addEventListener("click", ()=>
            {
                if(document.getElementById("mqttAddress").value.length < 8)
                {
                    alert("Please enter a valid URI");
                    return;
                }
                getJSON('/mqtt?uri=' + encodeURIComponent(document.getElementById("mqttAddress").value) + '&username=' + encodeURIComponent(document.getElementById("mqttUsernameInput").value) + '&password=' + encodeURIComponent(document.getElementById("mqttPasswordInput").value),
                    function(err, data) {
                        if (err !== null) {
                            alert('Something went wrong: ' + err);
                        } else {
                            alert(data.msg)
                        }
                    });
            });

            document.getElementById("calVoltageButton").addEventListener("click", ()=>
            {
                if(confirm("OK, take a true measurement using a multimeter then press OK immediately"))
                {
                    getJSON('/pm',
                        function(err, data) {
                            if (err !== null) {
                                alert('Something went wrong: ' + err);
                            } else {
                                var cal = parseFloat(prompt("Please enter the measured value in volts"));
                                if(!isNaN(cal))
                                {
                                    var correctionFactor = cal / data.vrms;
                                    getJSON('/cal?channel=' + encodeURIComponent(0) + '&factor=' + encodeURIComponent(correctionFactor),
                                        function(err, data) {
                                            if (err !== null) {
                                                alert('Something went wrong: ' + err);
                                            } else {
                                                alert('Calibrated, restarting to apply calibration');
                                            }
                                        });
                                }
                            }
                        });
                }
            });

            document.getElementById("calI1Button").addEventListener("click", ()=>
            {
                if(confirm("OK, take a true measurement using a multimeter then press OK immediately"))
                {
                    getJSON('/pm',
                        function(err, data) {
                            if (err !== null) {
                                alert('Something went wrong: ' + err);
                            } else {
                                var cal = parseFloat(prompt("Please enter the measured value in volts"));
                                if(!isNaN(cal))
                                {
                                    var correctionFactor = cal / data.irms[0];
                                    getJSON('/cal?channel=' + encodeURIComponent(1) + '&factor=' + encodeURIComponent(correctionFactor),
                                        function(err, data) {
                                            if (err !== null) {
                                                alert('Something went wrong: ' + err);
                                            } else {
                                                alert('Calibrated, restarting to apply calibration');
                                            }
                                        });
                                }
                            }
                        });
                }
            });

            document.getElementById("calI2Button").addEventListener("click", ()=>
            {
                if(confirm("OK, take a true measurement using a multimeter then press OK immediately"))
                {
                    getJSON('/pm',
                        function(err, data) {
                            if (err !== null) {
                                alert('Something went wrong: ' + err);
                            } else {
                                var cal = parseFloat(prompt("Please enter the measured value in volts"));
                                if(!isNaN(cal))
                                {
                                    var correctionFactor = cal / data.irms[1];
                                    getJSON('/cal?channel=' + encodeURIComponent(2) + '&factor=' + encodeURIComponent(correctionFactor),
                                        function(err, data) {
                                            if (err !== null) {
                                                alert('Something went wrong: ' + err);
                                            } else {
                                                alert('Calibrated, restarting to apply calibration');
                                            }
                                        });
                                }
                            }
                        });
                }
            });

            document.getElementById("calI3Button").addEventListener("click", ()=>
            {
                if(confirm("OK, take a true measurement using a multimeter then press OK immediately"))
                {
                    getJSON('/pm',
                        function(err, data) {
                            if (err !== null) {
                                alert('Something went wrong: ' + err);
                            } else {
                                var cal = parseFloat(prompt("Please enter the measured value in volts"));
                                if(!isNaN(cal))
                                {
                                    var correctionFactor = cal / data.irms[2];
                                    getJSON('/cal?channel=' + encodeURIComponent(3) + '&factor=' + encodeURIComponent(correctionFactor),
                                        function(err, data) {
                                            if (err !== null) {
                                                alert('Something went wrong: ' + err);
                                            } else {
                                                alert('Calibrated, restarting to apply calibration');
                                            }
                                        });
                                }
                            }
                        });
                }
            });

            document.getElementById("calI4Button").addEventListener("click", ()=>
            {
                if(confirm("OK, take a true measurement using a multimeter then press OK immediately"))
                {
                    getJSON('/pm',
                        function(err, data) {
                            if (err !== null) {
                                alert('Something went wrong: ' + err);
                            } else {
                                var cal = parseFloat(prompt("Please enter the measured value in volts"));
                                if(!isNaN(cal))
                                {
                                    var correctionFactor = cal / data.irms[3];
                                    getJSON('/cal?channel=' + encodeURIComponent(4) + '&factor=' + encodeURIComponent(correctionFactor),
                                        function(err, data) {
                                            if (err !== null) {
                                                alert('Something went wrong: ' + err);
                                            } else {
                                                alert('Calibrated, restarting to apply calibration');
                                            }
                                        });
                                }
                            }
                        });
                }
            });
            document.getElementById("resetCalButton").addEventListener("click", ()=>
            {
                if(confirm("Are you sure you want to clear all calibrations"))
                {
                    getJSON('/pm',
                        function(err, data) {
                            if (err !== null) {
                                alert('Something went wrong: ' + err);
                            } else {
                                getJSON('/cal?channel=' + encodeURIComponent(99) + '&factor=' + encodeURIComponent(0),
                                    function(err, data) {
                                        if (err !== null) {
                                            alert('Something went wrong: ' + err);
                                        } else {
                                            alert('Calibrated, restarting to apply calibration');
                                        }
                                    });
                            }
                        });
                }
            });
        </script>
    </footer>
</html>
